<% content_for :styles do %>
  <%= stylesheet_link_tag "views/journals/new" %>
<% end %>

<header class="topbar">
  <div class="brand-pill"><%= t("journal.title") %></div>
  <div class="topbar__spacer"></div>

  <div class="topbar__actions">
    <%= button_to t("common.logout", default: "Logout"),
    logout_path(locale: I18n.locale),
    method: :delete,
    class: "btn btn-ghost btn--sm topbar__logout" %>

    <%= link_to profile_path, class: "avatar-btn", title: t("common.profile", default: "Profile"), "aria-label": t("common.profile", default: "Profile") do %>
      <% if current_user&.profile&.picture&.attached? %>
        <%= image_tag(
          current_user.profile.picture.variant(resize_to_fill: [32, 32]),
          alt: current_user.name.presence || "Profile",
          class: "avatar-img",
        ) %>
      <% else %>
        <svg
          class="avatar-fallback"
          viewBox="0 0 24 24"
          width="32"
          height="32"
          aria-hidden="true"
        >
          <circle cx="12" cy="8" r="4" fill="currentColor" opacity="0.9"/>
          <path d="M4 20c0-4 4-6 8-6s8 2 8 6" fill="currentColor" opacity="0.6"/>
        </svg>
      <% end %>
    <% end %>
  </div>
</header>

<div class="shell">
  <nav class="sidenav">
    <%= link_to journal_entries_path, class: "nav-btn", title: "Dashboard" do %>
      <%= nav_btn icon: :dashboard, title: "Dashboard" %>
    <% end %>
    <%= nav_btn icon: :profile, title: "Profile" %>

    <%= link_to new_journal_entry_path, class: "nav-btn", title: "New Journal Entry" do %>
      <%= nav_btn icon: :new, title: "New" %>
    <% end %>

    <%= nav_btn icon: :tasks, title: "Tasks" %>
  </nav>

  <main class="main">
    <section class="journal journal-index">
      <header class="head row tight">
        <h2 style="margin:0"><%= t("journal.index.dashboard", default: "Dashboard") %></h2>
        <%= link_to t("journal.index.new"), new_journal_entry_path, class: "btn btn-primary" %>
      </header>

      <% if @journal_entries.any? %>
        <% grouped = @journal_entries.group_by(&:entry_date) %>

        <% grouped.sort_by { |date, _| date || Date.new(1970,1,1) }.reverse_each do |date, items| %>
          <div class="day-group">
            <div class="date-pill">
              <%= (
                if date
                  l(date, format: "%-d.%m.%Y")
                else
                  t("journal.index.no_date", default: "No date")
                end
              ) %>
            </div>

            <% items.each do |e| %>
              <article class="log-card">
                <div class="log-card__meta">
                  <% if e.time_from || e.time_to %>
                    <span class="time"><%= [e.time_from&.strftime("%H:%M"), e.time_to&.strftime("%H:%M")].compact.join("–") %></span>
                  <% end %>
                </div>

                <div class="log-card__body">
                  <h3 class="log-title">
                    <span class="muted"><%= t("journal.index.empty", default: "Log entry:") %></span>
                    <%= link_to (e.title.presence || t("journal.untitled", default: "Untitled")), e %>
                  </h3>
                  <p class="log-text">
                    <%= (e.body&.to_plain_text || "").strip.truncate(160, omission: "…") %>
                  </p>
                </div>

                <div class="log-card__actions">
                  <%= link_to t("common.edit", default: "edit"),
                  edit_journal_entry_path(e),
                  class: "btn btn-ghost" %>
                  <%= button_to t("common.delete", default: "delete"),
                  e,
                  method: :delete,
                  form: {
                    data: {
                      turbo_confirm: t("common.delete", default: "Delete this entry?"),
                    },
                  },
                  class: "btn btn-danger" %>
                </div>

                <%= link_to e, class: "peek", title: t("common.view", default: "View") do %>
                  <svg
                    viewBox="0 0 24 24"
                    width="18"
                    height="18"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    aria-hidden="true"
                  >
                    <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3"/>
                  </svg>
                <% end %>
              </article>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="empty">
          <p><%= t("journal.index.empty", default: "No entries yet.") %></p>
        </div>
      <% end %>
    </section>
  </main>
</div>
