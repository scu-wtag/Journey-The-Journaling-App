<% content_for :styles do %>
  <%= stylesheet_link_tag "views/profiles/show" %>
<% end %>

<header class="navbar">
  <%= link_to t("app.name"), root_path(locale: I18n.locale), class: "brand-pill" %>
</header>

<main class="page">
  <div class="page__back">
    <%= link_to(
      "&lt; #{t("common.back", default: "Zurück")}".html_safe,
      journal_entries_path(locale: I18n.locale),
      class: "backlink",
      id: "backLink",
      "aria-label": t("common.back", default: "Zurück"),
    ) %>
  </div>
  <div class="page__container">
    <h2 class="page__title"><%= t("common.profile") %></h2>

    <section class="profile">
      <div class="profile__head">
        <div class="profile__avatar">
          <div class="profile__frame">
            <% if @profile.errors.any? %>
              <div class="flash flash--error">
                <ul>
                  <% @profile.errors.full_messages.each do |m| %>
                    <li><%= m %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <% if @profile&.picture&.attached? && @profile.picture.blob&.persisted? %>
              <% if @profile.picture.variable? %>
                <%= image_tag(
                  @profile.picture.variant(resize_to_fill: [200, 200]).processed,
                  alt: t("profiles.show.profile_picture_alt"),
                  class: "profile__image",
                  id: "avatarImg",
                ) %>
              <% else %>
                <%= image_tag(
                  url_for(@profile.picture),
                  alt: t("profiles.show.profile_picture_alt"),
                  class: "profile__image",
                  id: "avatarImg",
                ) %>
              <% end %>
            <% else %>
              <img
                src="https://i.pravatar.cc/200?img=1"
                alt="<%= t('profiles.show.profile_picture_alt') %>"
                class="profile__image"
                id="avatarImg"
              />
              <img
                src="https://i.pravatar.cc/200?img=1"
                alt="<%= t('profiles.show.profile_picture_alt') %>"
                class="profile__image"
                id="avatarImg"
              />
            <% end %>
          </div>

          <%= form_with model: @profile,
            url: profile_path,
            method: :patch,
            local: true,
            data: { turbo: false },
            html: { multipart: true, class: "profile__form", id: "avatarForm" } do |f| %>

            <%= f.file_field :picture,
                         accept: "image/*",
                         class: "profile__file",
                         id: "avatarInput",
                         style: "display:none;" %>

            <button type="button" class="profile__edit" id="editAvatar">
              <%= t("common.edit") %>
            </button>
          <% end %>
        </div>

        <div class="profile__meta">
          <h3 class="profile__name" id="nameDisplay"><%= current_user.name %></h3>

          <%= form_with url: profile_path, method: :patch, id: "detailsForm", html: { class: "profile__details-form" } do %>
            <div class="profile__kv" id="details">
              <div class="profile__kv-item">
                <span class="profile__kv-label"><%= t("users.new.phone") %></span>
                <div
                  class="profile__kv-value"
                  data-key="phone"
                  data-type="text"
                  data-scope="profile"
                >
                  <%= @profile&.phone.presence || "-" %>
                </div>
              </div>

              <div class="profile__kv-item">
                <span class="profile__kv-label"><%= t("activerecord.attributes.profile.headquarters") %></span>
                <div
                  class="profile__kv-value"
                  data-key="headquarters"
                  data-type="text"
                  data-scope="profile"
                >
                  <%= @profile&.headquarters.presence || "-" %>
                </div>
              </div>

              <div class="profile__kv-item">
                <span class="profile__kv-label"><%= t("users.new.fields.email") %></span>
                <div
                  class="profile__kv-value"
                  data-key="email"
                  data-type="email"
                  data-scope="user"
                >
                  <%= current_user.email %>
                </div>
              </div>

              <div class="profile__kv-item">
                <span class="profile__kv-label"><%= t("users.new.birthday") %></span>
                <div
                  class="profile__kv-value"
                  data-key="birthday"
                  data-type="date"
                  data-scope="profile"
                >
                  <%= @profile&.birthday %>
                </div>
              </div>
            </div>
          <% end %>

          <div class="profile__toolbar">
            <button class="btn btn--sm" id="editBtn" type="button"><%= t("common.edit") %></button>
          </div>

          <div class="page__actions" id="saveBar" style="display:none;">
            <button class="btn btn--sm" id="cancelBtn" type="button"><%= t("common.cancel") %></button>
            <button class="btn" id="saveBtn" type="button" style="min-width:120px;"><%= t("common.save") %></button>
          </div>
        </div>
      </div>
    </section>

    <hr class="rule"/>

    <section class="settings">
      <h3 class="settings__title"><%= t("profiles.show.settings_title") %></h3>

      <div class="settings__row">
        <div class="settings__label"><%= t("profiles.show.preferred_language") %></div>
        <div class="settings__control">
          <select class="input" id="langSelect">
            <option value="en" <%= "selected" if I18n.locale.to_s == "en" %>>
              <%= t("profiles.language.english") %>
            </option>
            <option value="de" <%= "selected" if I18n.locale.to_s == "de" %>>
              <%= t("profiles.language.german") %>
            </option>
          </select>
        </div>
      </div>

      <div class="settings__row">
        <div class="settings__label"><%= t("profiles.show.mode") %></div>
        <div class="settings__control">
          <div class="mode-toggle">
            <span><%= t("profiles.show.light") %></span>
            <label class="toggle">
              <input type="checkbox" id="themeToggle"/>
              <span class="toggle__slider" aria-hidden="true"></span>
            </label>
            <span><%= t("profiles.show.dark") %></span>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<%= javascript_import_module_tag "profile_settings" %>
