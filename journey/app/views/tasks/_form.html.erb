<% action_url   = task.persisted? ? task_path(task) : team_tasks_path(@team) %>
<% action_method = task.persisted? ? :patch : :post %>

<%= form_with model: task,
              url: action_url,
              method: action_method,
              html: { class: "app", multipart: true } do |f| %>

  <header class="topbar">
    <div class="brand-pill"><%= t("tasks.title", default: "Tasks") %></div>
    <div class="topbar__spacer"></div>

    <div class="topbar__actions">
      <%= link_to profile_path, class: "avatar-btn", title: t("common.profile", default: "Profile"), "aria-label": t("common.profile", default: "Profile") do %>
        <% if current_user&.profile&.picture&.attached? %>
          <%= image_tag current_user.profile.picture.variant(resize_to_fill: [32, 32]),
                        alt: (current_user.name.presence || "Profile"),
                        class: "avatar-img" %>
        <% else %>
          <svg class="avatar-fallback" viewBox="0 0 24 24" width="32" height="32" aria-hidden="true">
            <circle cx="12" cy="8" r="4" fill="currentColor" opacity="0.9"/>
            <path d="M4 20c0-4 4-6 8-6s8 2 8 6" fill="currentColor" opacity="0.6"/>
          </svg>
        <% end %>
      <% end %>
    </div>
  </header>

  <div class="shell">
    <nav class="sidenav">
      <%= link_to journal_entries_path, class: "nav-btn", title: "Dashboard" do %>
        <%= nav_btn icon: :dashboard, title: "Dashboard" %>
      <% end %>

      <%= link_to teams_path, class: "nav-btn", title: "Teams" do %>
        <%= nav_btn icon: :profile, title: "Teams" %>
      <% end %>

      <%= link_to new_journal_entry_path, class: "nav-btn", title: "New Journal Entry" do %>
        <%= nav_btn icon: :new, title: "New" %>
      <% end %>

      <%= link_to team_tasks_path(@team), class: "nav-btn current", title: "Tasks" do %>
        <%= nav_btn icon: :tasks, title: "Tasks" %>
      <% end %>
    </nav>

    <main class="main">
      <section class="journal">
        <div class="head row tight">
          <h2>
            <%= task.persisted? ? t("tasks.edit", default: "Edit Task")
                                : t("tasks.new",  default: "New Task") %>
          </h2>

          <span class="chip chip--team">
            <%= t("tasks.team_label", default: "Team") %>:
            <strong><%= @team.name %></strong>
          </span>
        </div>

        <div class="card task-layout">
          <!-- linke Seite: Titel / Notes / Upload -->
          <div class="task-layout__left">
            <div class="field">
              <label class="label"><%= t("tasks.fields.title", default: "Title") %></label>
              <%= f.text_field :title,
                               class: "input",
                               required: true,
                               autofocus: true,
                               placeholder: t("tasks.placeholders.title", default: "Give it a short, clear title") %>
            </div>

            <div class="field">
              <label class="label"><%= t("tasks.fields.notes", default: "Description / Instructions") %></label>
              <%= f.text_area :notes,
                              class: "textarea",
                              rows: 10,
                              placeholder: t("tasks.placeholders.notes", default: "Some descriptions, instructions …") %>
            </div>

            <div class="field">
              <label class="label"><%= t("tasks.fields.files", default: "Upload files") %></label>
              <label class="file-label">
                <%= f.file_field :files, multiple: true, direct_upload: true, class: "file" %>
              </label>
            </div>
          </div>

          <!-- rechte Seite: Assign / Status / Due -->
          <div class="task-layout__right">
            <div class="field">
              <label class="label"><%= t("tasks.fields.assignee", default: "Assign to") %></label>
              <%= f.collection_select :assignee_id,
                                      @team.users.order(:name),
                                      :id,
                                      :name,
                                      { include_blank: t("tasks.unassigned", default: "Unassigned") },
                                      class: "input select" %>
            </div>

            <div class="field">
              <label class="label"><%= t("tasks.fields.status", default: "Status") %></label>
              <%= f.select :status,
                           Task.statuses.keys.map { |s| [s.humanize, s] },
                           {},
                           class: "input select" %>
            </div>

            <div class="field">
              <label class="label"><%= t("tasks.fields.due_on", default: "Due date") %></label>
              <%= f.date_field :due_on, class: "input" %>
            </div>
          </div>
        </div>

        <footer class="footer">
          <%= f.button type: :submit,
                       class: "btn btn-primary btn--lg",
                       data: { turbo_submits_with: t("tasks.saving", default: "Saving…") } do %>
            <svg class="btn__icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span><%= task.persisted? ? t("common.save", default: "Save")
                                      : t("common.create", default: "Create") %></span>
            <span class="btn__spinner" aria-hidden="true"></span>
          <% end %>

          <% if task.persisted? %>
            <%= link_to t("common.cancel", default: "Cancel"), task_path(task), class: "primary_cancel" %>
          <% else %>
            <%= link_to t("common.cancel", default: "Cancel"), team_tasks_path(@team), class: "primary_cancel" %>
          <% end %>
        </footer>
      </section>
    </main>
  </div>
<% end %>
