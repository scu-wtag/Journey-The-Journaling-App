<% content_for :styles do %>
  <%= stylesheet_link_tag "views/tasks/form_show", media: "all" %>
<% end %>

<div class="app">
  <header class="topbar">
    <div class="brand-pill"><%= t("app.name") %></div>
    <div class="topbar__spacer"></div>

    <div class="topbar__actions">
      <%= button_to t("common.logout", default: "Logout"),
      logout_path(locale: I18n.locale),
      method: :delete,
      class: "btn btn-ghost btn--sm topbar__logout" %>

      <%= link_to profile_path, class: "avatar-btn", title: t("common.profile", default: "Profile"), "aria-label": t("common.profile", default: "Profile") do %>
        <% if current_user&.profile&.picture&.attached? %>
          <%= image_tag current_user.profile.picture.variant(resize_to_fill: [32, 32]),
          alt: (current_user.name.presence || "Profile"),
          class: "avatar-img" %>
        <% else %>
          <svg
            class="avatar-fallback"
            viewBox="0 0 24 24"
            width="32"
            height="32"
            aria-hidden="true"
          >
            <circle cx="12" cy="8" r="4" fill="currentColor" opacity="0.9"/>
            <path d="M4 20c0-4 4-6 8-6s8 2 8 6" fill="currentColor" opacity="0.6"/>
          </svg>
        <% end %>
      <% end %>
    </div>
  </header>

  <div class="shell">
    <nav class="sidenav">
      <% dash_path = journal_entries_path %>
      <%= link_to dash_path,
              class: "nav-btn#{ current_page?(dash_path) ? ' current' : '' }",
              title: "Dashboard" do %>
        <%= nav_btn icon: :dashboard, title: "Dashboard" %>
      <% end %>

      <% teams_index = teams_path %>
      <%= link_to teams_index,
              class: "nav-btn#{ controller_name == 'teams' ? ' current' : '' }",
              title: "Teams" do %>
        <%= nav_btn icon: :profile, title: "Teams" %>
      <% end %>

      <% new_entry = new_journal_entry_path %>
      <%= link_to new_entry,
              class: "nav-btn#{ current_page?(new_entry) ? ' current' : '' }",
              title: "New Journal Entry" do %>
        <%= nav_btn icon: :new, title: "New" %>
      <% end %>

      <% tasks_href =
        if defined?(@task) && @task&.team
          team_tasks_path(@task.team)
        elsif defined?(@team) && @team.present?
          team_tasks_path(@team)
        else
          tasks_path
        end %>

      <%= link_to tasks_href,
              class: "nav-btn#{ controller_name == 'tasks' ? ' current' : '' }",
              title: "Tasks" do %>
        <%= nav_btn icon: :tasks, title: "Tasks" %>
      <% end %>
    </nav>

    <main class="main">
      <section class="journal">
        <div class="task-wrap">
          <article class="card task-card">
            <header class="task-head">
              <h1 class="task-title"><%= @task.title %></h1>
              <div class="task-head__right">
                <span class="badge"><%= @task.status.humanize %></span>
                <div class="task-head__actions">
                  <%= link_to t("common.edit", default: "Edit"),
                  edit_task_path(@task),
                  class: "btn btn-ghost" %>
                  <%= button_to t("common.delete", default: "Delete"),
                  task_path(@task),
                  method: :delete,
                  form: {
                    data: {
                      turbo_confirm: t("common.confirm", default: "Delete?"),
                    },
                  },
                  class: "btn btn-danger" %>
                </div>
              </div>
            </header>

            <ul class="task-meta">
              <li>
                <span class="muted"><%= t("tasks.fields.assignee", default: "Assignee") %>:</span>
                <%= @task.assignee&.name.presence || t("tasks.unassigned", default: "Unassigned") %>
              </li>

              <% if @task.due_on.present? %>
                <li>
                  <span class="muted"><%= t("tasks.fields.due_on", default: "Due date") %>:</span>
                  <%= l(@task.due_on, format: "%-d.%m.%Y") %>
                </li>
              <% end %>

              <% if @task.journal_entry_id.present? %>
                <li>
                  <span class="muted"><%= t("tasks.fields.journal_entry", default: "Related log entry") %>:</span>
                  <%= link_to @task.journal_entry.title,
                  journal_entry_path(@task.journal_entry),
                  class: "muted" %>
                </li>
              <% end %>
            </ul>

            <% if @task.notes.present? %>
              <div class="task-notes">
                <h3 class="muted"><%= t("tasks.fields.notes", default: "Notes") %></h3>
                <div class="rtx"><%= simple_format(@task.notes) %></div>
              </div>
            <% end %>

            <% if @task.files.attached? %>
              <section class="files">
                <h3 class="muted"><%= t("tasks.fields.files", default: "Attachments") %></h3>
                <ul>
                  <% @task.files.each do |file| %>
                    <li>
                      <%= link_to file.filename.to_s, url_for(file), target: "_blank", rel: "noopener" %>
                      <span class="muted">·
                        <%= number_to_human_size(file.byte_size) %></span>
                    </li>
                  <% end %>
                </ul>
              </section>
            <% end %>

            <div class="task-toggle">
              <% case @task.status %>
              <% when "todo" %>
                <%= button_to t("tasks.actions.start", default: "Start"),
                task_path(@task, task: { status: :in_progress }),
                method: :patch,
                class: "btn" %>
                <div class="w-spacer"></div>
                <%= button_to t("tasks.actions.mark_done", default: "Mark done"),
                task_path(@task, task: { status: :done }),
                method: :patch,
                class: "btn btn-primary" %>
              <% when "in_progress" %>
                <%= button_to t("tasks.actions.back_to_todo", default: "Back to To-Do"),
                task_path(@task, task: { status: :todo }),
                method: :patch,
                class: "btn" %>
                <div class="w-spacer"></div>
                <%= button_to t("tasks.actions.mark_done", default: "Mark done"),
                task_path(@task, task: { status: :done }),
                method: :patch,
                class: "btn btn-primary" %>
              <% when "done" %>
                <div class="done-row">
                  <span class="check" aria-hidden="true">✓</span>
                  <span><%= t("tasks.done_text", default: "This task is done.") %></span>
                </div>
                <div class="w-spacer"></div>
                <%= button_to t("tasks.actions.reopen", default: "Reopen"),
                task_path(@task, task: { status: :in_progress }),
                method: :patch,
                class: "btn" %>
              <% end %>
            </div>

            <footer class="task-foot">
              <%= link_to t("common.back", default: "Back"),
              team_tasks_path(@task.team),
              class: "btn" %>
            </footer>
          </article>
        </div>
      </section>
    </main>
  </div>
</div>
